{
	"name": "Default configuration",
	"description": "Default configuration: Button and optionally (depending on parameter configuration) BLE-presence required, plus optional relock timeout",
	"parameters":
	{
		"payload_filename":        "${PECKUS_PAYLOAD_FILENAME=/PAYLOAD.TXT}",
		"ble_presence":            "${PECKUS_BLE_PRESENCE=TRUE}",
		"ble_presence_grace_secs": "${PECKUS_BLE_PRESENCE_GRACE_SECS=15}",
		"relock_secs":             "${PECKUS_RELOCK_SECS=0}"
	},
	"workflows":
	[
		{
			"name":"DEPLOY",
			"initial-state":"DEPLOY:START",
			"states":
			[
				{
					"name":        "DEPLOY:START",
					"actions":     [],
					"transitions": [{"state":"DEPLOY:BLE-PAIR",     "conditions": ["boolean:true={ble_presence}",  "peckus:payload=UNINITIALIZED"]},
					                {"state":"DEPLOY:PAYLOAD-WAIT", "conditions": ["boolean:false={ble_presence}", "peckus:payload=UNINITIALIZED"]}],
					"jobs":        []
				},
				{
					"name":        "DEPLOY:BLE-PAIR",
					"actions":     ["ble:advertise=TRUE"],
					"transitions": [{"state":"DEPLOY:BLE-PAIRED", "conditions": ["ble:paired=TRUE"]}],
					"jobs":        [{"job": "led", "name": "blue:blink",  "data": {"states": [{"RED": "OFF", "GREEN": "OFF", "BLUE": "ON",  "millis": 500},
					                                                                          {"RED": "OFF", "GREEN": "OFF", "BLUE": "OFF", "millis": 500}]}}]
				},
				{
					"name":        "DEPLOY:BLE-PAIRED",
					"actions":     ["ble:advertise=FALSE", "timeout:seconds=CIRCUITPYTHON-SAVE-BLE-KEYS:5"],
					"transitions": [{"state": "DEPLOY:PAYLOAD-WAIT", "conditions": ["timeout:expired=CIRCUITPYTHON-SAVE-BLE-KEYS"]}],
					"jobs":        [{"job": "led", "name": "blue:on", "data": {"states": [{"RED": "OFF",  "GREEN": "OFF",  "BLUE": "ON"}]}}]
				},
				{
					"name":        "DEPLOY:PAYLOAD-WAIT",
					"actions":     [],
					"transitions": [{"state": "DEPLOY:PAYLOAD-INSTALL", "conditions": ["filesystem:exists={payload_filename}"]}],
					"jobs":        [{"job": "led", "name": "green:blink", "data": {"states": [{"RED": "OFF", "GREEN": "ON",  "BLUE": "OFF", "millis": 500},
					                                                                          {"RED": "OFF", "GREEN": "OFF", "BLUE": "OFF", "millis": 500}]}}]
				},
				{
					"name":        "DEPLOY:PAYLOAD-INSTALL",
					"actions":     ["peckus:install={payload_filename}"],
					"transitions": [{"state":"DEPLOY:READY", "conditions": ["peckus:payload=INSTALLED"]}],
					"jobs":        [{"job": "led", "name": "white:on", "data": {"states": [{"RED": "ON",  "GREEN": "ON",  "BLUE": "ON"}]}}]
				},
				{
					"name":       "DEPLOY:READY",
					"actions":    ["system:reset=NOW"],
					"transitions": [],
					"jobs":        []
				}
			]
		},
		{
			"name":"UNLOCK",
			"initial-state":"UNLOCK:START",
			"states":
			[
				{
					"name":        "UNLOCK:START",
					"actions":     [],
					"transitions": [{"state": "UNLOCK:BUTTON", "conditions": ["peckus:payload=INSTALLED", "filesystem:readonly=FALSE"]}],
					"jobs":        []
				},
				{
					"name":        "UNLOCK:BUTTON",
					"actions":     [],
					"transitions": [{"state": "UNLOCK:BLE-CONNECT", "conditions": ["boolean:true={ble_presence}",  "button:reset=TRUE"]},
					                {"state": "UNLOCK:EXEC",        "conditions": ["boolean:false={ble_presence}", "button:reset=TRUE"]}],
					"jobs":        [{"job": "led", "name": "red:on",  "data": {"states": [{"RED": "ON",  "GREEN": "OFF", "BLUE": "OFF"}]}}]
				},
				{
					"name":        "UNLOCK:BLE-CONNECT",
					"actions":     ["timeout:seconds=BLE-CONNECT:{ble_presence_grace_secs}"],
					"transitions": [{"state": "UNLOCK:RESET", "conditions": ["timeout:expired=BLE-CONNECT"]},
					                {"state": "UNLOCK:EXEC",  "conditions": ["ble:connected=TRUE"]}],
					"jobs":        [{"job": "led", "name": "red+blue:blink",  "data": {"states": [{"RED": "OFF", "GREEN": "OFF", "BLUE": "ON",  "millis": 500},
					                                                                              {"RED": "ON",  "GREEN": "OFF", "BLUE": "OFF", "millis": 500}]}}]
				},
				{
					"name":        "UNLOCK:EXEC",
					"actions":     ["peckus:unlock={payload_filename}"],
					"transitions": [],
					"jobs":        []
				},
				{
					"name":        "UNLOCK:RESET",
					"actions":     ["system:reset=NOW"],
					"transitions": [],
					"jobs":        []
				}
			]
		},
		{
			"name":"RELOCK",
			"initial-state":"RELOCK:START",
			"states":
			[
				{
					"name":        "RELOCK:START",
					"actions":     [],
					"transitions": [{"state": "RELOCK:UNLOCKED", "conditions": ["peckus:payload=UNLOCKED"]}],
					"jobs":        []
				},
				{
					"name":        "RELOCK:UNLOCKED",
					"actions":     ["timeout:seconds=RELOCK-TIMEOUT:{relock_secs}"],
					"transitions": [{"state": "RELOCK:BLE-CONNECTED", "conditions": ["boolean:true={ble_presence}"]},
					                {"state": "RELOCK:TIMEOUT",       "conditions": ["boolean:false={ble_presence}"]}],
					"jobs":        [{"job": "led", "name": "green:on",  "data": {"states": [{"RED": "OFF", "GREEN": "ON", "BLUE": "OFF"}]}}]
				},
				{
					"name":        "RELOCK:BLE-CONNECTED",
					"actions":     [],
					"transitions": [{"state": "RELOCK:BLE-DISCONNECTED", "conditions": ["ble:connected=FALSE"]},
					                {"state": "RELOCK:EXEC",             "conditions": ["timeout:expired=RELOCK-TIMEOUT"]}],
					"jobs":        [{"job": "led", "name": "green:on",  "data": {"states": [{"RED": "OFF", "GREEN": "ON", "BLUE": "OFF"}]}}]
				},
				{
					"name":        "RELOCK:BLE-DISCONNECTED",
					"actions":     ["timeout:seconds=BLE-DISCONNECTED:{ble_presence_grace_secs}"],
					"transitions": [{"state": "RELOCK:BLE-CONNECTED", "conditions": ["ble:connected=TRUE"]},
					                {"state": "RELOCK:EXEC",          "conditions": ["timeout:expired=BLE-DISCONNECTED"]},
					                {"state": "RELOCK:EXEC",          "conditions": ["timeout:expired=RELOCK-TIMEOUT"]}],
					"jobs":        [{"job": "led", "name": "green+blue:blink",  "data": {"states": [{"RED": "OFF", "GREEN": "OFF", "BLUE": "ON",  "millis": 500},
					                                                                                {"RED": "OFF", "GREEN": "ON",  "BLUE": "OFF", "millis": 500}]}}]
				},
				{
					"name":        "RELOCK:RELOCK-TIMEOUT",
					"actions":     [],
					"transitions": [{"state": "RELOCK:EXEC", "conditions": ["timeout:expired=RELOCK-TIMEOUT"]}],
					"jobs":        [{"job": "led", "name": "green:on",  "data": {"states": [{"RED": "OFF", "GREEN": "ON", "BLUE": "OFF"}]}}]
				},
				{
					"name":        "RELOCK:EXEC",
					"actions":     ["system:reset=NOW"],
					"transitions": [],
					"jobs":        []
				}
			]
		}
	]
}

